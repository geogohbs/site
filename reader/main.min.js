pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/pdf.worker.min.mjs";const url=`https://materials.hbs.geogo.org/bulletins/${window.location.search.substring(1)??"blank"}.pdf`,canvas1=document.querySelector("#can-1"),canvas2=document.querySelector("#can-2"),pageSlider=document.getElementById("page-slider"),prevBtn=document.getElementById("prev"),nextBtn=document.getElementById("next"),pageNumElem=document.getElementById("page-num"),loading=document.getElementById("loading"),passwordDialog=document.querySelector("dialog"),passwordInput=document.querySelector("#password"),passwordButton=document.querySelector("#password-btn"),minHeight=500,sqrt2=1.4142135624,revSqrt2=.7071067812,verticalMargin=80,horizontalMargin=24;let pdf=null,pdfMeta=null,currentPage=0,pageRendering=!1,pageNumPending=null,timerWindowSize=null,timerZoom=null,pagePerWindow=window.innerWidth>=800?2:1,scale=null,zoomLevel=1,pageHeight,pageWidth,viewPageHeight,viewPageWidth,isMouseOn=!1,password,preMousePosX=null,renderTask1=null,renderTask2=null;async function start(){password=window.localStorage.getItem("pw");let e=pdfjsLib.getDocument({url,password:password,cMapUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/cmaps/",disableFontFace:!0}).promise;try{pdf=await e,document.body.removeChild(loading),startRender()}catch(t){if(console.log(t.message),"No password given"!==t.message&&"Incorrect Password"!==t.message){alert("잘못된 접근");return}passwordDialog.showModal(),passwordButton.addEventListener("click",questPassword),passwordInput.addEventListener("keydown",function(e){"Enter"===e.key&&questPassword()})}}async function renderSinglePage(e,t=1){if(pageRendering=!0,1===pagePerWindow?canvas2.style.display="none":canvas2.style.display="block",canvas1.style.display="block",0===e||e===pdf.numPages+1){let a=0===e?canvas1:canvas2,n=a.getContext("2d"),r=new Image,g=window.devicePixelRatio||1;a.width=Math.floor(pageWidth*g),a.height=Math.floor(1.4142135624*pageWidth*g),a.style.width=Math.floor(pageWidth*scale)+"px",a.style.height=Math.floor(1.4142135624*pageWidth*scale)+"px",r.src="./blank.jpg",r.addEventListener("load",()=>{n.drawImage(r,0,0,a.width,a.height),t===pagePerWindow&&(pageRendering=!1)}),1===pagePerWindow&&1===t?pageNumElem.textContent=e+" / "+pdf.numPages:2===pagePerWindow&&1===t&&(pageNumElem.textContent=`${e}-${e+1} / ${pdf.numPages}`);return}let o=1===t?canvas1:canvas2,i=o.getContext("2d");i.clearRect(0,0,o.width,o.height),i.resetTransform(),i.translate(0,0),i.rotate(0);let s=await pdf.getPage(e),d=s.getViewport({scale:scale*zoomLevel}),l=window.devicePixelRatio||1;o.width=Math.floor(d.width*l),o.height=Math.floor(d.height*l),o.style.width=Math.floor(d.width/zoomLevel)+"px",o.style.height=Math.floor(d.height/zoomLevel)+"px";let p={canvasContext:i,transform:1!==l?[l,0,0,l,0,0]:null,viewport:d};if(1===t?renderTask1=s.render(p):renderTask2=s.render(p),1===t&&(1===pagePerWindow?pageNumElem.textContent=e+" / "+pdf.numPages:2===pagePerWindow&&e===pdf.numPages?pageNumElem.textContent=`${e}-END / ${pdf.numPages}`:2===pagePerWindow&&(pageNumElem.textContent=`${e}-${e+1} / ${pdf.numPages}`)),1===t)try{await renderTask1.promise}catch(u){console.log(u)}else try{await renderTask2.promise}catch(c){console.log(c)}t===pagePerWindow&&(pageRendering=!1),1===t?renderTask1=null:renderTask2=null}async function renderPages(e){if(console.log("Render"),pageRendering){console.log("Rendering in renderPages");return}1===pagePerWindow?await renderSinglePage(e,1):2===pagePerWindow?(await renderSinglePage(e,1),await renderSinglePage(e+1,2)):console.log("What the heck?")}function onPrevPage(){if(pageRendering){console.log("Rendering...");return}if(currentPage<=(2===pagePerWindow?0:1)){console.log("Page staring");return}currentPage-=pagePerWindow,pageSlider.value=currentPage,renderPages(currentPage)}function onNextPage(){if(pageRendering){console.log("Rendering...");return}if(currentPage>=pdf.numPages){console.log("Page end");return}currentPage+=pagePerWindow,pageSlider.value=currentPage,renderPages(currentPage)}async function questPassword(){console.log(password),password=passwordInput.value;let e=pdfjsLib.getDocument({url,password:password,cMapUrl:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/cmaps/",disableFontFace:!0}).promise;try{pdf=await e,window.localStorage.setItem("pw",password),document.body.removeChild(loading),startRender(),passwordDialog.close()}catch(t){console.log(t.message),passwordInput.value="",alert("비밀번호가 틀렸습니다.")}}function startRender(){pdf.getPage(1).then(e=>{let t=e.getViewport({scale:1});pageWidth=t.width,pageHeight=t.height,pagePerWindow=pageWidth*(scale=(window.innerHeight-80)/pageHeight)*2<window.innerWidth?2:1,scale=pageWidth*scale<window.innerWidth?scale:(window.innerWidth-24)/pageWidth,pageSlider.max=pdf.numPages,renderPages(currentPage=2===pagePerWindow?0:1),prevBtn.addEventListener("click",onPrevPage),nextBtn.addEventListener("click",onNextPage),window.addEventListener("mousedown",function(e){preMousePosX=e.clientX,console.log(preMousePosX)}),window.addEventListener("mouseup",function(e){e.clientX-preMousePosX<-12?onNextPage():e.clientX-preMousePosX>12&&onPrevPage()}),window.addEventListener("touchstart",function(e){1===e.targetTouches.length?(preMousePosX=e.targetTouches[0].clientX,console.log(preMousePosX)):preMousePosX=null,console.log("touch")}),window.addEventListener("touchend",function(e){null!==preMousePosX&&(e.changedTouches[0].clientX-preMousePosX<-12?onNextPage():e.changedTouches[0].clientX-preMousePosX>12&&onPrevPage()),console.log(e)}),window.addEventListener("resize",()=>{clearTimeout(timerWindowSize),timerWindowSize=setTimeout(()=>{pdf.getPage(1).then(e=>{let t=e.getViewport({scale:1});pageWidth=t.width,pageHeight=t.height,pagePerWindow=pageWidth*(scale=(window.innerHeight-80)/pageHeight)*2<window.innerWidth?2:1,scale=pageWidth*scale<window.innerWidth?scale:(window.innerWidth-24)/pageWidth,2===pagePerWindow?currentPage-=1&currentPage:1===pagePerWindow&&0===currentPage&&(currentPage=1),pageSlider.max=pdf.numPages,renderPages(currentPage)})},300)}),window.onkeyup=e=>{"ArrowRight"===e.key||" "===e.key?(e.preventDefault(),onNextPage()):"ArrowLeft"===e.key&&(e.preventDefault(),onPrevPage())},pageSlider.addEventListener("input",e=>{if(pageRendering)return;let t=parseInt(e.target.value);1===pagePerWindow?(currentPage=t,pageNumElem.textContent=currentPage+" / "+pdf.numPages):2===pagePerWindow&&(currentPage=(1&t)==1?t-1:t,pageNumElem.textContent=currentPage+"-"+(currentPage!==pdf.numPages?currentPage+1:"END")+" / "+pdf.numPages)}),pageSlider.addEventListener("change",e=>{if(pageRendering)return;let t=parseInt(e.target.value);1===pagePerWindow?currentPage=t:2===pagePerWindow&&(currentPage=(1&t)==1?t-1:t),console.log(currentPage),renderPages(currentPage)}),window.visualViewport.addEventListener("resize",e=>{clearTimeout(timerZoom),timerZoom=setTimeout(()=>{zoomLevel=window.visualViewport.scale,renderPages(currentPage)},300)})})}start();
